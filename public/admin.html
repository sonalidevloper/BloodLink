<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BloodLink Admin ‚Äì Hospital Command Center</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --red: #ff2d2d;
      --red-dim: rgba(255,45,45,0.15);
      --red-glow: rgba(255,45,45,0.3);
      --bg: #050507;
      --bg2: #0c0c10;
      --bg3: #13131a;
      --surface: #1a1a24;
      --surface2: #21212e;
      --border: rgba(255,255,255,0.06);
      --border2: rgba(255,255,255,0.12);
      --text: #e8e8f0;
      --text-muted: #6b6b80;
      --text-dim: #3a3a50;
      --green: #00d68f;
      --green-dim: rgba(0,214,143,0.12);
      --yellow: #ffb800;
      --yellow-dim: rgba(255,184,0,0.12);
      --blue: #4d9fff;
      --blue-dim: rgba(77,159,255,0.12);
      --mono: 'Space Mono', monospace;
      --sans: 'Outfit', sans-serif;
      --sidebar: 240px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: var(--sans); background: var(--bg); color: var(--text); min-height:100vh; display:flex; overflow-x:hidden; }

    /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
    .sidebar {
      width: var(--sidebar); background: var(--bg2);
      border-right: 1px solid var(--border);
      display:flex; flex-direction:column;
      position:fixed; top:0; left:0; bottom:0; z-index:50;
    }
    .sb-logo {
      padding: 22px 20px; border-bottom: 1px solid var(--border);
      display:flex; align-items:center; gap:10px;
    }
    .sb-logo-mark {
      width:34px; height:34px; background:var(--red);
      border-radius:8px; display:flex; align-items:center; justify-content:center;
      font-size:16px; box-shadow: 0 0 20px var(--red-glow);
      animation: pulse 2.5s infinite;
    }
    @keyframes pulse { 0%,100%{box-shadow:0 0 20px var(--red-glow)} 50%{box-shadow:0 0 35px rgba(255,45,45,0.5)} }
    .sb-logo-text { font-size:15px; font-weight:700; }
    .sb-logo-sub { font-size:9px; color:var(--text-muted); letter-spacing:2px; text-transform:uppercase; font-family:var(--mono); }

    .sb-nav { flex:1; padding:12px; overflow-y:auto; }
    .sb-section { font-size:9px; font-weight:700; letter-spacing:2.5px; text-transform:uppercase; color:var(--text-dim); padding:10px 8px 6px; font-family:var(--mono); }
    .sb-item {
      display:flex; align-items:center; gap:10px;
      padding:9px 10px; border-radius:8px;
      color:var(--text-muted); font-size:13px; font-weight:500;
      cursor:pointer; transition:all 0.15s; margin-bottom:1px;
      text-decoration:none; border:none; background:transparent; width:100%;
    }
    .sb-item i { width:16px; text-align:center; font-size:13px; }
    .sb-item:hover { background:var(--surface); color:var(--text); }
    .sb-item.active { background:var(--red-dim); color:var(--red); }
    .sb-badge {
      margin-left:auto; background:var(--red); color:white;
      font-size:9px; font-weight:700; padding:2px 6px;
      border-radius:100px; font-family:var(--mono);
    }
    .sb-badge.green { background:var(--green); color:#000; }

    .sb-footer { padding:12px; border-top:1px solid var(--border); }
    .sb-admin-card {
      padding:12px; background:var(--surface); border-radius:10px;
      display:flex; align-items:center; gap:10px;
    }
    .sb-avatar {
      width:34px; height:34px; background:var(--red);
      border-radius:8px; display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:14px; flex-shrink:0;
    }
    .sb-aname { font-size:12px; font-weight:600; }
    .sb-arole { font-size:10px; color:var(--text-muted); font-family:var(--mono); }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    .main { margin-left:var(--sidebar); flex:1; display:flex; flex-direction:column; }
    .topbar {
      padding:16px 32px; display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--border);
      background:rgba(5,5,7,0.9); backdrop-filter:blur(20px);
      position:sticky; top:0; z-index:40;
    }
    .topbar-left { display:flex; align-items:center; gap:12px; }
    .page-heading { font-size:17px; font-weight:700; }
    .live-badge {
      display:flex; align-items:center; gap:6px;
      background:var(--green-dim); border:1px solid rgba(0,214,143,0.25);
      border-radius:100px; padding:4px 10px;
      font-size:10px; font-weight:600; color:var(--green); font-family:var(--mono);
    }
    .live-dot { width:5px;height:5px;background:var(--green);border-radius:50%; animation:blink 1.2s infinite; }
    @keyframes blink { 0%,100%{opacity:1}50%{opacity:0.2} }
    .topbar-time { font-family:var(--mono); font-size:12px; color:var(--text-muted); }

    .btn {
      display:inline-flex; align-items:center; gap:7px;
      padding:8px 16px; border-radius:7px;
      font-family:var(--sans); font-size:12px; font-weight:600;
      cursor:pointer; transition:all 0.2s; border:none;
    }
    .btn-red { background:var(--red); color:#fff; }
    .btn-red:hover { background:#ff4444; box-shadow:0 4px 16px var(--red-glow); }
    .btn-ghost { background:transparent; color:var(--text-muted); border:1px solid var(--border); }
    .btn-ghost:hover { color:var(--text); border-color:var(--border2); background:var(--surface); }
    .btn-green { background:var(--green-dim); color:var(--green); border:1px solid rgba(0,214,143,0.25); }
    .btn-green:hover { background:rgba(0,214,143,0.2); }
    .btn-sm { padding:5px 12px; font-size:11px; }

    .content { padding:28px 32px; flex:1; }

    /* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
    .panel { display:none; }
    .panel.active { display:block; }

    /* ‚îÄ‚îÄ KPI GRID ‚îÄ‚îÄ */
    .kpi-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:24px; }
    .kpi-card {
      background:var(--surface); border:1px solid var(--border);
      border-radius:12px; padding:20px;
      position:relative; overflow:hidden;
      transition:transform 0.2s;
    }
    .kpi-card:hover { transform:translateY(-2px); }
    .kpi-card::after {
      content:''; position:absolute; bottom:0; left:0; right:0; height:2px;
      background:var(--accent, var(--red));
    }
    .kpi-card[data-accent="green"] { --accent:var(--green); }
    .kpi-card[data-accent="blue"] { --accent:var(--blue); }
    .kpi-card[data-accent="yellow"] { --accent:var(--yellow); }
    .kpi-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:14px; }
    .kpi-icon { font-size:20px; }
    .kpi-change { font-size:10px; font-family:var(--mono); padding:2px 7px; border-radius:100px; }
    .kpi-change.up { background:var(--green-dim); color:var(--green); }
    .kpi-change.warn { background:var(--yellow-dim); color:var(--yellow); }
    .kpi-val { font-size:32px; font-weight:800; font-family:var(--mono); margin-bottom:4px; }
    .kpi-label { font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; }

    /* ‚îÄ‚îÄ CHARTS SECTION ‚îÄ‚îÄ */
    .charts-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:24px; }
    .card {
      background:var(--surface); border:1px solid var(--border);
      border-radius:12px; overflow:hidden;
    }
    .card-hd {
      padding:16px 20px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
    }
    .card-title { font-size:13px; font-weight:700; }
    .card-sub { font-size:11px; color:var(--text-muted); margin-top:2px; font-family:var(--mono); }
    .card-body { padding:20px; }

    /* Blood type bars */
    .blood-bars { display:flex; flex-direction:column; gap:12px; }
    .blood-bar-item { display:flex; align-items:center; gap:12px; }
    .blood-type-tag {
      width:36px; font-family:var(--mono); font-size:12px; font-weight:700;
      color:var(--red); text-align:center; flex-shrink:0;
    }
    .bar-track { flex:1; height:8px; background:var(--bg3); border-radius:4px; overflow:hidden; }
    .bar-fill { height:100%; border-radius:4px; background:var(--red); transition:width 1s cubic-bezier(0.4,0,0.2,1); }
    .bar-fill.critical { background:var(--yellow); }
    .bar-fill.ok { background:var(--green); }
    .bar-count { font-family:var(--mono); font-size:11px; color:var(--text-muted); width:28px; text-align:right; flex-shrink:0; }

    /* Activity feed */
    .activity-feed { display:flex; flex-direction:column; gap:0; }
    .activity-item {
      display:flex; align-items:flex-start; gap:12px;
      padding:12px 0; border-bottom:1px solid var(--border);
    }
    .activity-item:last-child { border-bottom:none; }
    .act-icon {
      width:32px; height:32px; border-radius:8px;
      display:flex; align-items:center; justify-content:center;
      font-size:13px; flex-shrink:0; margin-top:1px;
    }
    .act-icon.red { background:var(--red-dim); }
    .act-icon.green { background:var(--green-dim); }
    .act-icon.blue { background:var(--blue-dim); }
    .act-icon.yellow { background:var(--yellow-dim); }
    .act-text { flex:1; }
    .act-title { font-size:12px; font-weight:600; margin-bottom:2px; }
    .act-sub { font-size:11px; color:var(--text-muted); }
    .act-time { font-family:var(--mono); font-size:10px; color:var(--text-dim); white-space:nowrap; }

    /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
    .tbl-wrap { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; }
    thead th {
      padding:10px 14px; text-align:left;
      font-size:10px; font-weight:700; font-family:var(--mono);
      color:var(--text-dim); letter-spacing:1.5px; text-transform:uppercase;
      border-bottom:1px solid var(--border); background:var(--bg2);
    }
    tbody td { padding:12px 14px; font-size:12px; border-bottom:1px solid var(--border); }
    tbody tr:hover td { background:rgba(255,255,255,0.02); }
    tbody tr:last-child td { border-bottom:none; }

    /* ‚îÄ‚îÄ TAGS ‚îÄ‚îÄ */
    .tag {
      display:inline-flex; align-items:center; gap:4px;
      padding:3px 8px; border-radius:100px;
      font-size:10px; font-weight:700; font-family:var(--mono);
    }
    .tag.red { background:var(--red-dim); color:var(--red); }
    .tag.green { background:var(--green-dim); color:var(--green); }
    .tag.yellow { background:var(--yellow-dim); color:var(--yellow); }
    .tag.blue { background:var(--blue-dim); color:var(--blue); }
    .tag.gray { background:rgba(255,255,255,0.05); color:var(--text-muted); }

    /* ‚îÄ‚îÄ INVENTORY PANEL ‚îÄ‚îÄ */
    .inventory-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; }
    .inv-card {
      background:var(--bg3); border:1px solid var(--border);
      border-radius:12px; padding:18px; text-align:center;
      transition:all 0.2s; cursor:pointer;
      position:relative; overflow:hidden;
    }
    .inv-card::before {
      content:''; position:absolute; top:0; left:0; right:0; height:3px;
      background:var(--inv-color, var(--red));
    }
    .inv-card:hover { transform:translateY(-3px); box-shadow:0 12px 24px rgba(0,0,0,0.4); }
    .inv-blood { font-family:var(--mono); font-size:28px; font-weight:700; color:var(--inv-color, var(--red)); margin-bottom:6px; }
    .inv-units { font-size:22px; font-weight:800; margin-bottom:4px; }
    .inv-label { font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:12px; }
    .inv-bar { height:4px; background:var(--bg); border-radius:2px; overflow:hidden; }
    .inv-bar-fill { height:100%; border-radius:2px; background:var(--inv-color, var(--red)); }
    .inv-status { font-size:10px; font-weight:600; margin-top:8px; font-family:var(--mono); }
    .inv-status.critical { color:#ff4444; }
    .inv-status.low { color:var(--yellow); }
    .inv-status.ok { color:var(--green); }

    .inv-controls { display:flex; gap:8px; margin-top:10px; justify-content:center; }

    /* ‚îÄ‚îÄ DONOR TABLE ‚îÄ‚îÄ */
    .donor-filters { display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap; }
    .filter-btn {
      padding:6px 14px; border-radius:100px;
      font-size:11px; font-weight:600; cursor:pointer;
      border:1px solid var(--border); background:transparent;
      color:var(--text-muted); transition:all 0.2s; font-family:var(--mono);
    }
    .filter-btn.active, .filter-btn:hover { background:var(--red-dim); color:var(--red); border-color:rgba(255,45,45,0.3); }

    .search-box {
      padding:9px 14px; background:var(--bg3); border:1px solid var(--border);
      border-radius:8px; color:var(--text); font-family:var(--sans); font-size:13px;
      outline:none; transition:border 0.2s; width:240px;
    }
    .search-box:focus { border-color:rgba(255,45,45,0.4); }

    /* ‚îÄ‚îÄ REQUESTS PANEL ‚îÄ‚îÄ */
    .req-kanban { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; }
    .kanban-col { background:var(--bg2); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .kanban-hd {
      padding:12px 16px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
    }
    .kanban-title { font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:1px; font-family:var(--mono); }
    .kanban-count {
      width:20px; height:20px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:10px; font-weight:700; font-family:var(--mono);
    }
    .kanban-body { padding:12px; display:flex; flex-direction:column; gap:10px; min-height:200px; }
    .req-card {
      background:var(--surface2); border:1px solid var(--border);
      border-radius:10px; padding:14px;
      transition:all 0.2s; cursor:default;
    }
    .req-card:hover { border-color:var(--border2); }
    .req-card-top { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .req-blood {
      font-family:var(--mono); font-size:18px; font-weight:700;
      color:var(--red);
    }
    .req-info { font-size:11px; color:var(--text-muted); line-height:1.6; margin-bottom:10px; }
    .req-actions { display:flex; gap:6px; }

    /* ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ */
    .notif-list { display:flex; flex-direction:column; gap:10px; }
    .notif-item {
      display:flex; align-items:flex-start; gap:12px;
      padding:14px; background:var(--bg3); border:1px solid var(--border);
      border-radius:10px; transition:all 0.2s;
    }
    .notif-item.unread { border-color:rgba(255,45,45,0.2); background:rgba(255,45,45,0.04); }
    .notif-dot { width:7px; height:7px; border-radius:50%; background:var(--red); flex-shrink:0; margin-top:4px; }
    .notif-dot.read { background:transparent; border:1px solid var(--text-dim); }

    /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
    .modal-overlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px);
      z-index:1000; display:none; align-items:center; justify-content:center; padding:20px;
    }
    .modal-overlay.open { display:flex; }
    .modal {
      background:var(--bg2); border:1px solid var(--border2);
      border-radius:16px; width:100%; max-width:480px;
      box-shadow:0 40px 80px rgba(0,0,0,0.7);
      animation:modalIn 0.25s ease;
    }
    @keyframes modalIn { from{opacity:0;transform:scale(0.96)} to{opacity:1;transform:scale(1)} }
    .modal-hd { padding:24px 28px 18px; border-bottom:1px solid var(--border); }
    .modal-hd h3 { font-size:18px; font-weight:700; margin-bottom:4px; }
    .modal-hd p { font-size:12px; color:var(--text-muted); }
    .modal-body { padding:20px 28px 28px; }
    .form-group { margin-bottom:16px; }
    .form-group label { display:block; font-size:10px; font-weight:700; font-family:var(--mono); color:var(--text-muted); margin-bottom:7px; letter-spacing:1px; text-transform:uppercase; }
    .form-ctrl {
      width:100%; padding:10px 14px; background:var(--bg3);
      border:1px solid var(--border); border-radius:8px;
      color:var(--text); font-family:var(--sans); font-size:13px;
      outline:none; transition:border 0.2s; appearance:none;
    }
    .form-ctrl:focus { border-color:rgba(255,45,45,0.4); }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .modal-footer { display:flex; gap:10px; justify-content:flex-end; padding-top:16px; border-top:1px solid var(--border); }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    #toasts { position:fixed; top:70px; right:20px; z-index:2000; display:flex; flex-direction:column; gap:8px; }
    .toast {
      min-width:280px; background:var(--surface2); border:1px solid var(--border2);
      border-radius:10px; padding:12px 14px;
      display:flex; gap:10px; align-items:center;
      box-shadow:0 16px 32px rgba(0,0,0,0.5);
      animation:toastIn 0.25s ease;
    }
    @keyframes toastIn { from{opacity:0;transform:translateX(16px)} to{opacity:1;transform:translateX(0)} }
    .toast-icon { font-size:16px; }
    .toast-msg { font-size:12px; font-weight:500; flex:1; }
    .toast-x { font-size:12px; color:var(--text-dim); cursor:pointer; }

    /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
    .empty {
      text-align:center; padding:40px 20px; color:var(--text-muted);
    }
    .empty i { font-size:32px; display:block; margin-bottom:10px; opacity:0.2; }
    .empty h4 { font-size:14px; font-weight:700; color:var(--text-dim); margin-bottom:6px; }
    .empty p { font-size:12px; }

    @media(max-width:900px) {
      .sidebar { transform:translateX(-100%); }
      .main { margin-left:0; }
      .kpi-grid, .inventory-grid { grid-template-columns:1fr 1fr; }
      .req-kanban, .charts-row { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>

<div id="toasts"></div>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sb-logo">
    <div class="sb-logo-mark">ü©∏</div>
    <div>
      <div class="sb-logo-text">BloodLink</div>
      <div class="sb-logo-sub">Admin Console</div>
    </div>
  </div>
  <nav class="sb-nav">
    <div class="sb-section">Overview</div>
    <button class="sb-item active" onclick="showPanel('overview',this)"><i class="fas fa-th-large"></i> Command Center</button>
    <button class="sb-item" onclick="showPanel('requests',this)"><i class="fas fa-tint"></i> Blood Requests <span class="sb-badge" id="open-count">0</span></button>

    <div class="sb-section" style="margin-top:10px">Management</div>
    <button class="sb-item" onclick="showPanel('inventory',this)"><i class="fas fa-vials"></i> Blood Inventory</button>
    <button class="sb-item" onclick="showPanel('donors',this)"><i class="fas fa-users"></i> Donors <span class="sb-badge green" id="donor-count">0</span></button>
    <button class="sb-item" onclick="showPanel('hospitals',this)"><i class="fas fa-hospital"></i> Hospitals</button>

    <div class="sb-section" style="margin-top:10px">System</div>
    <button class="sb-item" onclick="showPanel('notifications',this)"><i class="fas fa-bell"></i> Alerts <span class="sb-badge" id="alert-count">3</span></button>
    <button class="sb-item" onclick="showPanel('settings',this)"><i class="fas fa-cog"></i> Settings</button>
    <button class="sb-item" onclick="goBack()"><i class="fas fa-arrow-left"></i> Back to App</button>
  </nav>
  <div class="sb-footer">
    <div class="sb-admin-card">
      <div class="sb-avatar">A</div>
      <div>
        <div class="sb-aname">Admin</div>
        <div class="sb-arole">SUPER_ADMIN</div>
      </div>
    </div>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <div class="page-heading" id="page-heading">Command Center</div>
      <div class="live-badge"><div class="live-dot"></div> LIVE</div>
    </div>
    <div style="display:flex;align-items:center;gap:16px">
      <div class="topbar-time" id="clock">‚Äî</div>
      <button class="btn btn-red btn-sm" onclick="openAddInventory()"><i class="fas fa-plus"></i> Add Blood</button>
    </div>
  </div>

  <div class="content">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OVERVIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel active" id="panel-overview">

      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-top">
            <div class="kpi-icon">ü©∏</div>
            <div class="kpi-change up">‚Üë 12%</div>
          </div>
          <div class="kpi-val" id="kpi-requests">‚Äî</div>
          <div class="kpi-label">Active Requests</div>
        </div>
        <div class="kpi-card" data-accent="green">
          <div class="kpi-top">
            <div class="kpi-icon">üë•</div>
            <div class="kpi-change up">‚Üë 8%</div>
          </div>
          <div class="kpi-val" id="kpi-donors">‚Äî</div>
          <div class="kpi-label">Active Donors</div>
        </div>
        <div class="kpi-card" data-accent="blue">
          <div class="kpi-top">
            <div class="kpi-icon">üè•</div>
            <div class="kpi-change up">‚Üë 3%</div>
          </div>
          <div class="kpi-val" id="kpi-units">‚Äî</div>
          <div class="kpi-label">Units in Stock</div>
        </div>
        <div class="kpi-card" data-accent="yellow">
          <div class="kpi-top">
            <div class="kpi-icon">‚ö°</div>
            <div class="kpi-change warn">! Critical</div>
          </div>
          <div class="kpi-val" id="kpi-critical">‚Äî</div>
          <div class="kpi-label">Critical Requests</div>
        </div>
      </div>

      <div class="charts-row">
        <!-- Blood type inventory bars -->
        <div class="card">
          <div class="card-hd">
            <div>
              <div class="card-title">Blood Inventory Status</div>
              <div class="card-sub">Units per type ¬∑ Updated live</div>
            </div>
            <button class="btn btn-ghost btn-sm" onclick="loadInventory()"><i class="fas fa-sync"></i></button>
          </div>
          <div class="card-body">
            <div class="blood-bars" id="inventory-bars">
              <div style="text-align:center;padding:20px;color:var(--text-dim)">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Activity feed -->
        <div class="card">
          <div class="card-hd">
            <div>
              <div class="card-title">Live Activity</div>
              <div class="card-sub">Real-time system events</div>
            </div>
            <span class="tag green">LIVE</span>
          </div>
          <div class="card-body">
            <div class="activity-feed" id="activity-feed">
              <div style="text-align:center;padding:20px;color:var(--text-dim)">Loading...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent requests table -->
      <div class="card">
        <div class="card-hd">
          <div>
            <div class="card-title">Recent Blood Requests</div>
            <div class="card-sub">Last 10 requests across all blood types</div>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="showPanel('requests',null)">View All <i class="fas fa-arrow-right"></i></button>
        </div>
        <div class="tbl-wrap">
          <table>
            <thead>
              <tr>
                <th>Request ID</th>
                <th>Blood Type</th>
                <th>Urgency</th>
                <th>Status</th>
                <th>Time</th>
                <th>Matches</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="requests-table-body">
              <tr><td colspan="7" class="empty"><i class="fas fa-spinner fa-spin"></i></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REQUESTS PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-requests">
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:20px;flex-wrap:wrap">
        <div class="filter-btn active" onclick="filterRequests('all',this)">All</div>
        <div class="filter-btn" onclick="filterRequests('open',this)">Open</div>
        <div class="filter-btn" onclick="filterRequests('High',this)">üî¥ Critical</div>
        <div class="filter-btn" onclick="filterRequests('Medium',this)">üü° Medium</div>
        <div class="filter-btn" onclick="filterRequests('fulfilled',this)">‚úÖ Fulfilled</div>
        <div style="margin-left:auto">
          <button class="btn btn-ghost btn-sm" onclick="loadRequests()"><i class="fas fa-sync"></i> Refresh</button>
        </div>
      </div>
      <div class="req-kanban" id="req-kanban">
        <div class="kanban-col">
          <div class="kanban-hd">
            <div class="kanban-title" style="color:var(--red)">üî¥ Critical</div>
            <div class="kanban-count" style="background:var(--red-dim);color:var(--red)" id="col-high-count">0</div>
          </div>
          <div class="kanban-body" id="col-high"></div>
        </div>
        <div class="kanban-col">
          <div class="kanban-hd">
            <div class="kanban-title" style="color:var(--yellow)">üü° Medium</div>
            <div class="kanban-count" style="background:var(--yellow-dim);color:var(--yellow)" id="col-med-count">0</div>
          </div>
          <div class="kanban-body" id="col-med"></div>
        </div>
        <div class="kanban-col">
          <div class="kanban-hd">
            <div class="kanban-title" style="color:var(--green)">üü¢ Low / Fulfilled</div>
            <div class="kanban-count" style="background:var(--green-dim);color:var(--green)" id="col-low-count">0</div>
          </div>
          <div class="kanban-body" id="col-low"></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INVENTORY PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-inventory">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <div>
          <h2 style="font-size:16px;font-weight:700">Blood Bank Inventory</h2>
          <p style="font-size:11px;color:var(--text-muted);font-family:var(--mono);margin-top:3px">Manage units by blood type</p>
        </div>
        <button class="btn btn-red" onclick="openAddInventory()"><i class="fas fa-plus"></i> Add Blood Units</button>
      </div>
      <div class="inventory-grid" id="inventory-grid">
        <!-- filled by JS -->
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DONORS PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-donors">
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap">
        <input type="text" class="search-box" placeholder="üîç Search donors..." id="donor-search" oninput="filterDonors()" >
        <div class="filter-btn active" onclick="setDonorFilter('all',this)">All</div>
        <div class="filter-btn" onclick="setDonorFilter('available',this)">Available</div>
        <div class="filter-btn" onclick="setDonorFilter('unavailable',this)">Unavailable</div>
        <div style="margin-left:auto">
          <button class="btn btn-ghost btn-sm" onclick="loadDonors()"><i class="fas fa-sync"></i></button>
        </div>
      </div>
      <div class="card">
        <div class="tbl-wrap">
          <table>
            <thead>
              <tr>
                <th>Donor</th>
                <th>Blood Type</th>
                <th>Status</th>
                <th>Location</th>
                <th>Last Updated</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="donors-table-body">
              <tr><td colspan="6" class="empty"><i class="fas fa-spinner fa-spin"></i></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOSPITALS PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-hospitals">
      <div class="card">
        <div class="card-hd">
          <div class="card-title">Partner Hospitals & Blood Banks</div>
          <button class="btn btn-red btn-sm" onclick="openAddHospital()"><i class="fas fa-plus"></i> Add Hospital</button>
        </div>
        <div class="tbl-wrap">
          <table>
            <thead>
              <tr><th>Hospital</th><th>City</th><th>Type</th><th>Status</th><th>Blood Units</th><th>Contact</th></tr>
            </thead>
            <tbody id="hospitals-body">
              <!-- Demo data -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NOTIFICATIONS PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-notifications">
      <div style="display:flex;justify-content:space-between;margin-bottom:16px">
        <h2 style="font-size:15px;font-weight:700">System Alerts</h2>
        <button class="btn btn-ghost btn-sm" onclick="markAllRead()">Mark all read</button>
      </div>
      <div class="notif-list" id="notif-list">
        <!-- Filled by JS -->
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-settings">
      <div class="card" style="max-width:560px">
        <div class="card-hd"><div class="card-title">System Settings</div></div>
        <div class="card-body" style="display:flex;flex-direction:column;gap:20px">
          <div>
            <div style="font-size:13px;font-weight:600;margin-bottom:6px">Search Radius (km)</div>
            <input class="form-ctrl" type="number" value="50" style="max-width:120px">
          </div>
          <div>
            <div style="font-size:13px;font-weight:600;margin-bottom:6px">Critical Stock Threshold (units)</div>
            <input class="form-ctrl" type="number" value="5" style="max-width:120px">
          </div>
          <div>
            <div style="font-size:13px;font-weight:600;margin-bottom:6px">Auto-notify Donors</div>
            <div style="display:flex;align-items:center;gap:10px">
              <div id="auto-notify-toggle" class="toggle on" onclick="this.classList.toggle('on')" style="width:44px;height:24px;background:var(--green);border-radius:12px;cursor:pointer;position:relative;transition:background 0.3s">
                <div style="position:absolute;top:2px;left:2px;width:18px;height:18px;background:white;border-radius:50%;transition:left 0.3s;left:22px"></div>
              </div>
              <span style="font-size:12px;color:var(--text-muted)">Send push alerts to matching donors</span>
            </div>
          </div>
          <div>
            <div style="font-size:13px;font-weight:600;margin-bottom:6px">Admin Password</div>
            <div style="display:flex;gap:10px">
              <input class="form-ctrl" type="password" placeholder="New password" style="max-width:200px">
              <button class="btn btn-ghost btn-sm">Update</button>
            </div>
          </div>
          <button class="btn btn-red" style="width:fit-content" onclick="toast('Settings saved','success')">Save Settings</button>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<!-- ADD INVENTORY MODAL -->
<div class="modal-overlay" id="modal-inventory">
  <div class="modal">
    <div class="modal-hd">
      <h3>Add Blood Units</h3>
      <p>Update inventory for a blood type</p>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>Blood Type</label>
          <select class="form-ctrl" id="inv-blood">
            <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
            <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
          </select>
        </div>
        <div class="form-group">
          <label>Units to Add</label>
          <input class="form-ctrl" type="number" id="inv-units" value="10" min="1">
        </div>
      </div>
      <div class="form-group">
        <label>Expiry Date</label>
        <input class="form-ctrl" type="date" id="inv-expiry">
      </div>
      <div class="form-group">
        <label>Source</label>
        <input class="form-ctrl" id="inv-source" placeholder="Blood bank name or donor ID">
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-red" onclick="saveInventory()"><i class="fas fa-plus"></i> Add Units</button>
      </div>
    </div>
  </div>
</div>

<!-- FULFILL REQUEST MODAL -->
<div class="modal-overlay" id="modal-fulfill">
  <div class="modal">
    <div class="modal-hd">
      <h3>Fulfill Request</h3>
      <p>Mark this request as fulfilled and update inventory</p>
    </div>
    <div class="modal-body">
      <div id="fulfill-details" style="background:var(--bg3);border-radius:8px;padding:14px;margin-bottom:16px;font-size:13px;"></div>
      <div class="form-group">
        <label>Assigned Donor / Source</label>
        <input class="form-ctrl" id="fulfill-source" placeholder="Donor name or blood bank">
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea class="form-ctrl" id="fulfill-notes" rows="2" placeholder="Optional notes"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-green" onclick="confirmFulfill()"><i class="fas fa-check"></i> Mark Fulfilled</button>
      </div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  // ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
  const token = localStorage.getItem('token');
  const socket = io();
  let allRequests = [];
  let allDonors = [];
  let donorFilter = 'all';
  let currentFulfillId = null;

  const BLOOD_TYPES = ['A+','A-','B+','B-','AB+','AB-','O+','O-'];
  let inventory = { 'A+':12,'A-':4,'B+':18,'B-':3,'AB+':7,'AB-':2,'O+':22,'O-':5 };

  // ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ
  setInterval(() => {
    document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
  }, 1000);

  // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
  async function init() {
    socket.on('notification', data => {
      toast('ü©∏ New Blood Request', data.message || 'New request received', 'urgent');
      loadOverview();
    });
    await loadOverview();
    await loadRequests();
    await loadDonors();
    renderInventory();
    renderHospitals();
    renderNotifications();
  }

  // ‚îÄ‚îÄ OVERVIEW ‚îÄ‚îÄ
  async function loadOverview() {
    try {
      const res = await fetch('/api/admin/stats', { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();

      document.getElementById('kpi-requests').textContent = data.openRequests || 0;
      document.getElementById('kpi-donors').textContent = data.activeDonors || 0;
      document.getElementById('kpi-units').textContent = Object.values(inventory).reduce((a,b)=>a+b, 0);
      document.getElementById('kpi-critical').textContent = data.criticalRequests || 0;
      document.getElementById('open-count').textContent = data.openRequests || 0;
      document.getElementById('donor-count').textContent = data.activeDonors || 0;

      renderInventoryBars();
      renderActivity(data.recentRequests || []);
      renderRequestsTable(data.recentRequests || []);
    } catch(e) {
      // Demo fallback
      document.getElementById('kpi-requests').textContent = allRequests.filter(r=>r.status==='open').length;
      document.getElementById('kpi-donors').textContent = allDonors.filter(d=>d.available).length;
      document.getElementById('kpi-units').textContent = Object.values(inventory).reduce((a,b)=>a+b, 0);
      document.getElementById('kpi-critical').textContent = allRequests.filter(r=>r.urgency==='High').length;
      renderInventoryBars();
      renderActivity(allRequests.slice(0,5));
      renderRequestsTable(allRequests.slice(0,10));
    }
  }

  function renderInventoryBars() {
    const maxUnits = Math.max(...Object.values(inventory), 1);
    document.getElementById('inventory-bars').innerHTML = BLOOD_TYPES.map(bt => {
      const units = inventory[bt] || 0;
      const pct = (units / 30 * 100).toFixed(0);
      const cls = units <= 3 ? 'critical' : units <= 8 ? '' : 'ok';
      return `<div class="blood-bar-item">
        <div class="blood-type-tag">${bt}</div>
        <div class="bar-track"><div class="bar-fill ${cls}" style="width:${pct}%"></div></div>
        <div class="bar-count">${units}</div>
      </div>`;
    }).join('');
  }

  function renderActivity(requests) {
    const activities = [
      ...requests.slice(0,3).map((r,i) => ({
        icon:'ü©∏', cls:'red', title:`Blood request: ${r.bloodType || '?'}`, sub:`${r.urgency || 'Medium'} priority ¬∑ ${timeAgo(r.createdAt)}`, time: timeAgo(r.createdAt)
      })),
      { icon:'‚úÖ', cls:'green', title:'Donor verified', sub:'New donor registration approved', time:'5m ago' },
      { icon:'üì¶', cls:'blue', title:'Inventory updated', sub:'O+ restocked (+10 units)', time:'1h ago' },
      { icon:'‚ö†Ô∏è', cls:'yellow', title:'Low stock alert', sub:'AB- critically low (2 units)', time:'2h ago' }
    ];
    document.getElementById('activity-feed').innerHTML = activities.slice(0,6).map(a => `
      <div class="activity-item">
        <div class="act-icon ${a.cls}">${a.icon}</div>
        <div class="act-text">
          <div class="act-title">${a.title}</div>
          <div class="act-sub">${a.sub}</div>
        </div>
        <div class="act-time">${a.time}</div>
      </div>
    `).join('');
  }

  function renderRequestsTable(requests) {
    if (!requests.length) {
      document.getElementById('requests-table-body').innerHTML = `<tr><td colspan="7"><div class="empty"><i class="fas fa-inbox"></i><h4>No requests</h4><p>No blood requests in the system yet</p></div></td></tr>`;
      return;
    }
    document.getElementById('requests-table-body').innerHTML = requests.map((r, i) => `
      <tr>
        <td style="font-family:var(--mono);font-size:10px;color:var(--text-muted)">#${(r._id||'').toString().slice(-6).toUpperCase() || String(i+1000)}</td>
        <td><span class="tag red">${r.bloodType || '?'}</span></td>
        <td><span class="tag ${r.urgency==='High'?'red':r.urgency==='Medium'?'yellow':'green'}">${r.urgency||'Medium'}</span></td>
        <td><span class="tag ${r.status==='open'?'yellow':r.status==='fulfilled'?'green':'gray'}">${r.status||'open'}</span></td>
        <td style="font-family:var(--mono);font-size:11px;color:var(--text-muted)">${timeAgo(r.createdAt)}</td>
        <td style="font-family:var(--mono);font-size:11px">${r.matchedDonors?.length || '‚Äî'}</td>
        <td>
          ${r.status==='open' ? `<button class="btn btn-green btn-sm" onclick="openFulfill('${r._id}','${r.bloodType}','${r.urgency}')">Fulfill</button>` : '<span style="color:var(--text-dim);font-size:11px">‚Äî</span>'}
        </td>
      </tr>
    `).join('');
  }

  // ‚îÄ‚îÄ REQUESTS ‚îÄ‚îÄ
  async function loadRequests() {
    try {
      const res = await fetch('/api/admin/requests', { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();
      allRequests = data.requests || [];
      renderKanban(allRequests);
    } catch(e) { renderKanban([]); }
  }

  function renderKanban(requests) {
    const high = requests.filter(r => r.urgency === 'High' && r.status === 'open');
    const med = requests.filter(r => r.urgency === 'Medium' && r.status === 'open');
    const low = requests.filter(r => r.urgency === 'Low' || r.status !== 'open');

    document.getElementById('col-high-count').textContent = high.length;
    document.getElementById('col-med-count').textContent = med.length;
    document.getElementById('col-low-count').textContent = low.length;

    const makeCard = r => `
      <div class="req-card">
        <div class="req-card-top">
          <div class="req-blood">${r.bloodType}</div>
          <span class="tag ${r.urgency==='High'?'red':r.urgency==='Medium'?'yellow':'green'}">${r.urgency}</span>
        </div>
        <div class="req-info">
          üìç ${r.location?.lat ? `${r.location.lat.toFixed(3)}, ${r.location.lng.toFixed(3)}` : 'Location unknown'}<br>
          üïê ${timeAgo(r.createdAt)}<br>
          ${r.notes ? `üìù ${r.notes.substring(0,40)}...` : ''}
        </div>
        <div class="req-actions">
          ${r.status==='open' ? `<button class="btn btn-green btn-sm" onclick="openFulfill('${r._id}','${r.bloodType}','${r.urgency}')"><i class="fas fa-check"></i> Fulfill</button>` : '<span class="tag green">‚úÖ Done</span>'}
          <button class="btn btn-ghost btn-sm" onclick="notifyDonors('${r._id}','${r.bloodType}')"><i class="fas fa-bell"></i></button>
        </div>
      </div>`;

    document.getElementById('col-high').innerHTML = high.length ? high.map(makeCard).join('') : '<div class="empty"><i class="fas fa-check-circle" style="color:var(--green)"></i><p>No critical requests</p></div>';
    document.getElementById('col-med').innerHTML = med.length ? med.map(makeCard).join('') : '<div class="empty"><i class="fas fa-check-circle"></i><p>No medium priority</p></div>';
    document.getElementById('col-low').innerHTML = low.length ? low.map(makeCard).join('') : '<div class="empty"><i class="fas fa-inbox"></i><p>No other requests</p></div>';
  }

  function filterRequests(type, el) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    if(el) el.classList.add('active');
    const filtered = type === 'all' ? allRequests
      : type === 'open' ? allRequests.filter(r => r.status === 'open')
      : type === 'fulfilled' ? allRequests.filter(r => r.status === 'fulfilled')
      : allRequests.filter(r => r.urgency === type);
    renderKanban(filtered);
  }

  // ‚îÄ‚îÄ DONORS ‚îÄ‚îÄ
  async function loadDonors() {
    try {
      const res = await fetch('/api/admin/donors', { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();
      allDonors = data.donors || [];
      document.getElementById('donor-count').textContent = allDonors.filter(d=>d.available).length;
      renderDonorsTable(allDonors);
    } catch(e) { renderDonorsTable([]); }
  }

  function renderDonorsTable(donors) {
    if (!donors.length) {
      document.getElementById('donors-table-body').innerHTML = `<tr><td colspan="6"><div class="empty"><i class="fas fa-users"></i><h4>No donors found</h4><p>No registered donors yet</p></div></td></tr>`;
      return;
    }
    document.getElementById('donors-table-body').innerHTML = donors.map(d => `
      <tr>
        <td>
          <div style="display:flex;align-items:center;gap:10px">
            <div style="width:30px;height:30px;border-radius:7px;background:var(--red-dim);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:var(--red)">
              ${(d.username || '?')[0].toUpperCase()}
            </div>
            <div>
              <div style="font-size:12px;font-weight:600">${d.username || 'Unknown'}</div>
              <div style="font-size:10px;color:var(--text-dim);font-family:var(--mono)">${(d.userId||'').toString().slice(-8)}</div>
            </div>
          </div>
        </td>
        <td><span class="tag red">${d.bloodType}</span></td>
        <td>
          <span class="tag ${d.available?'green':'gray'}">
            ${d.available ? '‚óè Available' : '‚óã Away'}
          </span>
        </td>
        <td style="font-size:11px;color:var(--text-muted);font-family:var(--mono)">
          ${d.location?.lat ? `${d.location.lat.toFixed(3)}, ${d.location.lng.toFixed(3)}` : '‚Äî'}
        </td>
        <td style="font-family:var(--mono);font-size:10px;color:var(--text-dim)">${timeAgo(d.updatedAt)}</td>
        <td>
          <button class="btn btn-ghost btn-sm" onclick="notifyDonor('${d.userId}','${d.bloodType}')"><i class="fas fa-bell"></i></button>
        </td>
      </tr>
    `).join('');
  }

  let donorSearchFilter = 'all';
  function setDonorFilter(type, el) {
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
    if(el) el.classList.add('active');
    donorSearchFilter = type;
    filterDonors();
  }
  function filterDonors() {
    const q = document.getElementById('donor-search').value.toLowerCase();
    let filtered = allDonors.filter(d =>
      (d.username||'').toLowerCase().includes(q) || (d.bloodType||'').toLowerCase().includes(q)
    );
    if (donorSearchFilter === 'available') filtered = filtered.filter(d=>d.available);
    if (donorSearchFilter === 'unavailable') filtered = filtered.filter(d=>!d.available);
    renderDonorsTable(filtered);
  }

  // ‚îÄ‚îÄ INVENTORY ‚îÄ‚îÄ
  function renderInventory() {
    const colors = { 'A+':'#ff2d2d','A-':'#ff6b6b','B+':'#ff8c00','B-':'#ffa500','AB+':'#4d9fff','AB-':'#00aaff','O+':'#00d68f','O-':'#00b377' };
    document.getElementById('inventory-grid').innerHTML = BLOOD_TYPES.map(bt => {
      const units = inventory[bt] || 0;
      const max = 30;
      const pct = Math.min(units / max * 100, 100);
      const status = units <= 3 ? 'critical' : units <= 8 ? 'low' : 'ok';
      const statusText = units <= 3 ? '‚ö†Ô∏è Critical' : units <= 8 ? '‚ö° Low Stock' : '‚úÖ Adequate';
      return `<div class="inv-card" style="--inv-color:${colors[bt]}">
        <div class="inv-blood">${bt}</div>
        <div class="inv-units">${units}</div>
        <div class="inv-label">Units Available</div>
        <div class="inv-bar"><div class="inv-bar-fill" style="width:${pct}%"></div></div>
        <div class="inv-status ${status}">${statusText}</div>
        <div class="inv-controls">
          <button class="btn btn-ghost btn-sm" onclick="adjustInventory('${bt}',-1)" style="padding:4px 10px">‚àí</button>
          <button class="btn btn-red btn-sm" onclick="adjustInventory('${bt}',1)" style="padding:4px 10px">+</button>
        </div>
      </div>`;
    }).join('');
  }

  function adjustInventory(bt, delta) {
    inventory[bt] = Math.max(0, (inventory[bt] || 0) + delta);
    renderInventory();
    renderInventoryBars();
    document.getElementById('kpi-units').textContent = Object.values(inventory).reduce((a,b)=>a+b,0);
    toast(`${bt} updated`, `${inventory[bt]} units remaining`, inventory[bt]<=3?'urgent':'success');
  }

  async function loadInventory() {
    renderInventoryBars();
    toast('Inventory refreshed', 'Data is up to date', 'success');
  }

  // ‚îÄ‚îÄ HOSPITALS ‚îÄ‚îÄ
  function renderHospitals() {
    const hospitals = [
      { name:'City General Hospital', city:'Mumbai', type:'Government', status:'Active', units:45, contact:'+91-22-1234' },
      { name:'Apollo Blood Bank', city:'Delhi', type:'Private', status:'Active', units:120, contact:'+91-11-5678' },
      { name:'Red Cross Center', city:'Bangalore', type:'NGO', status:'Active', units:28, contact:'+91-80-9012' },
      { name:'District Hospital', city:'Chennai', type:'Government', status:'Inactive', units:8, contact:'+91-44-3456' },
    ];
    document.getElementById('hospitals-body').innerHTML = hospitals.map(h => `
      <tr>
        <td style="font-weight:600;font-size:13px">${h.name}</td>
        <td style="font-size:12px">${h.city}</td>
        <td><span class="tag ${h.type==='Government'?'blue':h.type==='Private'?'yellow':'green'}">${h.type}</span></td>
        <td><span class="tag ${h.status==='Active'?'green':'gray'}">${h.status}</span></td>
        <td style="font-family:var(--mono);font-size:12px;font-weight:700">${h.units}</td>
        <td style="font-size:11px;color:var(--text-muted);font-family:var(--mono)">${h.contact}</td>
      </tr>
    `).join('');
  }

  // ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ
  function renderNotifications() {
    const notifs = [
      { title:'Critical: AB- blood needed', sub:'Patient at City Hospital requires immediate AB- transfusion', time:'2m ago', unread:true, type:'urgent' },
      { title:'Low inventory alert', sub:'O- blood type is below critical threshold (2 units)', time:'15m ago', unread:true, type:'warn' },
      { title:'New donor registered', sub:'Donor with O+ blood type registered and verified', time:'1h ago', unread:true, type:'info' },
      { title:'Request fulfilled', sub:'A+ blood request #A4F2 successfully matched and fulfilled', time:'2h ago', unread:false, type:'success' },
      { title:'System health check', sub:'All systems operational. Last backup: today 06:00', time:'3h ago', unread:false, type:'info' },
    ];
    document.getElementById('notif-list').innerHTML = notifs.map(n => `
      <div class="notif-item ${n.unread?'unread':''}">
        <div class="notif-dot ${n.unread?'':'read'}"></div>
        <div style="flex:1">
          <div style="font-size:13px;font-weight:600;margin-bottom:3px">${n.title}</div>
          <div style="font-size:11px;color:var(--text-muted)">${n.sub}</div>
        </div>
        <div style="font-family:var(--mono);font-size:10px;color:var(--text-dim);white-space:nowrap">${n.time}</div>
      </div>
    `).join('');
    document.getElementById('alert-count').textContent = notifs.filter(n=>n.unread).length;
  }

  function markAllRead() {
    document.querySelectorAll('.notif-item').forEach(el => {
      el.classList.remove('unread');
      el.querySelector('.notif-dot').className = 'notif-dot read';
    });
    document.getElementById('alert-count').textContent = '0';
  }

  // ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ
  function openAddInventory() {
    const d = new Date(); d.setDate(d.getDate() + 42);
    document.getElementById('inv-expiry').value = d.toISOString().split('T')[0];
    document.getElementById('modal-inventory').classList.add('open');
  }

  function openAddHospital() {
    toast('Coming soon', 'Hospital management feature in progress', 'info');
  }

  async function saveInventory() {
    const bt = document.getElementById('inv-blood').value;
    const units = parseInt(document.getElementById('inv-units').value) || 0;
    inventory[bt] = (inventory[bt] || 0) + units;
    renderInventory();
    renderInventoryBars();
    closeModal();
    toast(`Inventory updated`, `Added ${units} units of ${bt}`, 'success');
  }

  function openFulfill(id, bt, urgency) {
    currentFulfillId = id;
    document.getElementById('fulfill-details').innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <span class="tag red" style="font-size:14px">${bt}</span>
        <span class="tag ${urgency==='High'?'red':'yellow'}">${urgency}</span>
        <span style="font-size:11px;color:var(--text-muted);font-family:var(--mono)">ID: ${id.toString().slice(-8).toUpperCase()}</span>
      </div>
    `;
    document.getElementById('modal-fulfill').classList.add('open');
  }

  async function confirmFulfill() {
    if (!currentFulfillId) return;
    try {
      const res = await fetch(`/api/admin/fulfill/${currentFulfillId}`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json', Authorization:`Bearer ${token}` },
        body: JSON.stringify({ source: document.getElementById('fulfill-source').value, notes: document.getElementById('fulfill-notes').value })
      });
      if (res.ok) {
        toast('Request fulfilled!', 'Status updated and notifications sent', 'success');
        closeModal();
        await loadRequests();
        await loadOverview();
      }
    } catch(e) {
      toast('Updated locally', 'Request marked as fulfilled', 'success');
      allRequests = allRequests.map(r => r._id == currentFulfillId ? {...r, status:'fulfilled'} : r);
      renderKanban(allRequests);
      closeModal();
    }
  }

  function closeModal() {
    document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open'));
  }
  document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', e => { if(e.target===m) closeModal(); }));

  // ‚îÄ‚îÄ NOTIFY ‚îÄ‚îÄ
  async function notifyDonors(reqId, bloodType) {
    try {
      await fetch('/api/admin/notify', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', Authorization:`Bearer ${token}` },
        body: JSON.stringify({ requestId: reqId, bloodType })
      });
    } catch(e) {}
    toast(`Donors notified`, `Alert sent to ${bloodType} donors`, 'success');
  }

  function notifyDonor(userId, bloodType) {
    toast('Alert sent', `Notification sent to ${bloodType} donor`, 'success');
  }

  // ‚îÄ‚îÄ PANEL NAVIGATION ‚îÄ‚îÄ
  function showPanel(id, el) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.sb-item').forEach(b => b.classList.remove('active'));
    document.getElementById('panel-' + id).classList.add('active');
    if (el) el.classList.add('active');
    const titles = { overview:'Command Center', requests:'Blood Requests', inventory:'Blood Inventory', donors:'Donor Management', hospitals:'Hospitals', notifications:'System Alerts', settings:'Settings' };
    document.getElementById('page-heading').textContent = titles[id] || id;
    if (id === 'inventory') renderInventory();
  }

  function goBack() { window.location.href = '/dashboard.html'; }

  // ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
  function toast(title, msg, type='info') {
    const icons = { urgent:'ü©∏', success:'‚úÖ', info:'‚ÑπÔ∏è', warn:'‚ö†Ô∏è', error:'‚ùå' };
    const el = document.createElement('div');
    el.className = 'toast';
    el.innerHTML = `<div class="toast-icon">${icons[type]||'‚ÑπÔ∏è'}</div><div class="toast-msg"><strong>${title}</strong><br><span style="font-size:10px;opacity:0.7">${msg}</span></div><div class="toast-x" onclick="this.parentElement.remove()">‚úï</div>`;
    document.getElementById('toasts').appendChild(el);
    setTimeout(()=>el.remove(), 4000);
  }

  // ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
  function timeAgo(d) {
    if (!d) return '‚Äî';
    const diff = Date.now() - new Date(d).getTime();
    const m = Math.floor(diff/60000);
    if (m < 1) return 'Just now';
    if (m < 60) return m+'m ago';
    const h = Math.floor(m/60);
    if (h < 24) return h+'h ago';
    return Math.floor(h/24)+'d ago';
  }

  init();
</script>
</body>
</html>