<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BloodLink ‚Äì Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --red: #e81c1c;
      --red-dark: #a80000;
      --red-glow: rgba(232,28,28,0.3);
      --bg: #0a0a0b;
      --bg2: #111114;
      --bg3: #18181d;
      --surface: #1e1e25;
      --surface2: #252530;
      --border: rgba(255,255,255,0.07);
      --border2: rgba(255,255,255,0.12);
      --text: #f0f0f4;
      --text-muted: #7a7a8c;
      --text-dim: #4a4a5a;
      --success: #22c55e;
      --warning: #f59e0b;
      --info: #3b82f6;
      --sidebar-w: 260px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; display:flex; }

    /* ===== SIDEBAR ===== */
    .sidebar {
      width: var(--sidebar-w);
      background: var(--bg2);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      position: fixed; top:0; left:0; bottom:0;
      z-index: 50;
    }

    .sidebar-logo {
      padding: 24px 24px 20px;
      display: flex; align-items: center; gap: 10px;
      border-bottom: 1px solid var(--border);
    }
    .logo-icon {
      width: 36px; height: 36px;
      background: var(--red);
      border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
      box-shadow: 0 0 16px var(--red-glow);
    }
    .logo-text { font-family:'Syne',sans-serif; font-weight:800; font-size:18px; }

    .nav-section {
      padding: 16px 14px;
      flex: 1;
      overflow-y: auto;
    }
    .nav-label {
      font-size: 10px; font-weight: 600;
      letter-spacing: 2px; text-transform: uppercase;
      color: var(--text-dim);
      padding: 8px 10px 6px;
      margin-bottom: 4px;
    }
    .nav-item {
      display: flex; align-items: center; gap: 12px;
      padding: 11px 12px;
      border-radius: 10px;
      color: var(--text-muted);
      font-size: 14px; font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      text-decoration: none;
      margin-bottom: 2px;
    }
    .nav-item i { width: 18px; text-align: center; font-size: 15px; }
    .nav-item:hover { background: var(--surface); color: var(--text); }
    .nav-item.active { background: rgba(232,28,28,0.12); color: var(--red); }
    .nav-item .badge {
      margin-left: auto;
      background: var(--red);
      color: white;
      font-size: 10px; font-weight: 700;
      padding: 2px 7px;
      border-radius: 100px;
      min-width: 20px; text-align: center;
    }

    .sidebar-footer {
      padding: 16px 14px;
      border-top: 1px solid var(--border);
    }
    .user-card {
      display: flex; align-items: center; gap: 12px;
      padding: 12px;
      background: var(--surface);
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .user-card:hover { background: var(--surface2); }
    .avatar {
      width: 38px; height: 38px;
      border-radius: 10px;
      background: var(--red);
      display: flex; align-items: center; justify-content: center;
      font-family: 'Syne',sans-serif; font-weight: 700; font-size: 16px;
    }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: 11px; color: var(--text-muted); margin-top: 1px; }

    /* ===== MAIN ===== */
    .main {
      margin-left: var(--sidebar-w);
      flex: 1;
      display: flex; flex-direction: column;
      min-height: 100vh;
    }

    .topbar {
      padding: 20px 36px;
      display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid var(--border);
      background: rgba(10,10,11,0.8);
      backdrop-filter: blur(16px);
      position: sticky; top: 0; z-index: 40;
    }
    .page-title { font-family:'Syne',sans-serif; font-weight:700; font-size:20px; }
    .topbar-right { display:flex; gap:12px; align-items:center; }

    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 9px 18px;
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px; font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .btn-primary { background:var(--red); color:white; }
    .btn-primary:hover { background:#ff2424; box-shadow: 0 4px 16px var(--red-glow); }
    .btn-ghost { background:transparent; color:var(--text-muted); border:1px solid var(--border); }
    .btn-ghost:hover { color:var(--text); border-color:var(--border2); background:var(--surface); }
    .btn-sm { padding: 7px 14px; font-size: 12px; }
    .btn-success { background: rgba(34,197,94,0.15); color:#4ade80; border:1px solid rgba(34,197,94,0.3); }
    .btn-danger { background: rgba(232,28,28,0.15); color:#f87171; border:1px solid rgba(232,28,28,0.3); }

    .content { padding: 32px 36px; flex: 1; }

    /* ===== PANELS ===== */
    .panel { display: none; }
    .panel.active { display: block; }

    /* ===== STATS GRID ===== */
    .stats-grid {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 20px; margin-bottom: 28px;
    }
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 22px 24px;
      transition: all 0.2s;
      cursor: default;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 12px 24px rgba(0,0,0,0.3); }
    .stat-card-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .stat-icon {
      width: 42px; height: 42px;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }
    .stat-icon.red { background: rgba(232,28,28,0.12); }
    .stat-icon.green { background: rgba(34,197,94,0.12); }
    .stat-icon.blue { background: rgba(59,130,246,0.12); }
    .stat-icon.orange { background: rgba(245,158,11,0.12); }
    .stat-trend { font-size: 12px; color: var(--success); }
    .stat-num { font-family:'Syne',sans-serif; font-size:30px; font-weight:800; margin-bottom:4px; }
    .stat-label { font-size:12px; color:var(--text-muted); }

    /* ===== TOGGLE ===== */
    .toggle-wrap {
      display: flex; align-items: center; justify-content: space-between;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px 24px;
      margin-bottom: 24px;
    }
    .toggle-info h3 { font-family:'Syne',sans-serif; font-size:16px; font-weight:700; }
    .toggle-info p { font-size:13px; color:var(--text-muted); margin-top:4px; }
    .toggle {
      width: 56px; height: 30px;
      background: var(--surface2);
      border-radius: 15px;
      cursor: pointer;
      position: relative;
      transition: background 0.3s;
      border: 1px solid var(--border);
    }
    .toggle.on { background: var(--success); border-color: var(--success); }
    .toggle::after {
      content: '';
      position: absolute; top: 3px; left: 4px;
      width: 22px; height: 22px;
      background: white;
      border-radius: 50%;
      transition: left 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .toggle.on::after { left: 29px; }
    .status-indicator {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 12px; font-weight: 500;
      padding: 4px 10px;
      border-radius: 100px;
    }
    .status-indicator.available { background:rgba(34,197,94,0.12); color:var(--success); }
    .status-indicator.unavailable { background:rgba(100,100,120,0.15); color:var(--text-dim); }
    .status-dot { width:6px;height:6px;border-radius:50%; background:currentColor; animation: blink 1.5s infinite; }
    @keyframes blink { 0%,100%{opacity:1}50%{opacity:0.3} }

    /* ===== CARDS ===== */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      margin-bottom: 24px;
    }
    .card-header {
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .card-title { font-family:'Syne',sans-serif; font-size:15px; font-weight:700; }
    .card-body { padding: 24px; }

    /* ===== REQUEST ITEMS ===== */
    .request-item {
      display: flex; align-items: center; gap: 16px;
      padding: 16px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }
    .request-item:hover { border-color: var(--border2); }
    .blood-badge {
      width: 52px; height: 52px; flex-shrink: 0;
      background: rgba(232,28,28,0.1);
      border: 1.5px solid rgba(232,28,28,0.3);
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-family:'Syne',sans-serif;
      font-size: 14px; font-weight: 800;
      color: var(--red);
    }
    .request-info { flex: 1; min-width: 0; }
    .request-title { font-size:14px; font-weight:600; margin-bottom:4px; }
    .request-meta { display:flex; gap:14px; flex-wrap:wrap; }
    .meta-tag {
      font-size: 11px; color: var(--text-muted);
      display: flex; align-items: center; gap: 4px;
    }
    .urgency-badge {
      font-size: 10px; font-weight: 600;
      padding: 3px 8px; border-radius: 100px;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .urgency-badge.high { background:rgba(232,28,28,0.15); color:#f87171; }
    .urgency-badge.medium { background:rgba(245,158,11,0.15); color:#fbbf24; }
    .urgency-badge.low { background:rgba(34,197,94,0.12); color:#4ade80; }

    /* ===== FORM ===== */
    .form-group { margin-bottom:18px; }
    .form-group label {
      display:block; font-size:11px; font-weight:600;
      color:var(--text-muted); margin-bottom:8px;
      letter-spacing:0.5px; text-transform:uppercase;
    }
    .form-control {
      width:100%; padding:12px 14px;
      background:var(--bg3); border:1px solid var(--border);
      border-radius:10px; color:var(--text);
      font-family:'DM Sans',sans-serif; font-size:14px;
      transition:all 0.2s; outline:none; appearance:none;
    }
    .form-control:focus { border-color:rgba(232,28,28,0.5); box-shadow:0 0 0 3px rgba(232,28,28,0.08); }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }

    /* ===== ALERTS ===== */
    .alert {
      display: flex; align-items: flex-start; gap: 12px;
      padding: 14px 16px;
      border-radius: 10px;
      margin-bottom: 12px;
      font-size: 14px;
    }
    .alert-urgent { background:rgba(232,28,28,0.1); border:1px solid rgba(232,28,28,0.3); color:#f87171; }
    .alert-info { background:rgba(59,130,246,0.1); border:1px solid rgba(59,130,246,0.2); color:#93c5fd; }
    .alert-success { background:rgba(34,197,94,0.1); border:1px solid rgba(34,197,94,0.2); color:#4ade80; }
    .alert-icon { font-size:18px; margin-top:1px; flex-shrink:0; }

    /* ===== MAP ===== */
    #map {
      width:100%; height:380px;
      border-radius:12px;
      background:var(--bg3);
      border:1px solid var(--border);
      display:flex;align-items:center;justify-content:center;
      color:var(--text-muted);
      font-size:14px;
      flex-direction:column;
      gap:12px;
    }
    #map i { font-size:36px; color:var(--red); opacity:0.5; }

    /* ===== HISTORY TABLE ===== */
    .table { width:100%; border-collapse:collapse; }
    .table th {
      text-align:left; padding:12px 16px;
      font-size:11px; font-weight:600;
      color:var(--text-dim);
      letter-spacing:0.5px; text-transform:uppercase;
      border-bottom:1px solid var(--border);
    }
    .table td {
      padding:14px 16px;
      font-size:13px;
      border-bottom:1px solid var(--border);
    }
    .table tr:last-child td { border-bottom:none; }
    .table tr:hover td { background:rgba(255,255,255,0.02); }

    /* ===== EMPTY STATE ===== */
    .empty-state {
      text-align:center; padding:48px 24px;
      color:var(--text-muted);
    }
    .empty-state i { font-size:40px; margin-bottom:12px; opacity:0.3; display:block; }
    .empty-state h3 { font-family:'Syne',sans-serif; font-size:16px; font-weight:700; color:var(--text-dim); margin-bottom:6px; }
    .empty-state p { font-size:13px; }

    /* ===== NOTIFICATION TOAST ===== */
    .toast-container {
      position:fixed; top:80px; right:24px;
      z-index:1000;
      display:flex; flex-direction:column; gap:10px;
    }
    .toast {
      min-width: 320px; max-width: 360px;
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: 12px;
      padding: 14px 16px;
      display: flex; gap: 12px; align-items: flex-start;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      animation: toastIn 0.3s ease;
    }
    .toast.urgent { border-color: rgba(232,28,28,0.4); }
    @keyframes toastIn { from { opacity:0; transform:translateX(20px); } to { opacity:1; transform:translateX(0); } }
    .toast-icon { width:36px;height:36px; border-radius:8px; background:rgba(232,28,28,0.15); display:flex;align-items:center;justify-content:center; font-size:16px; flex-shrink:0; }
    .toast-title { font-size:13px; font-weight:600; margin-bottom:3px; }
    .toast-sub { font-size:12px; color:var(--text-muted); }
    .toast-close { margin-left:auto; color:var(--text-dim); cursor:pointer; font-size:14px; padding:2px; }

    /* ===== PROFILE ===== */
    .profile-header {
      display:flex; align-items:center; gap:20px;
      padding:28px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:14px;
      margin-bottom:24px;
    }
    .profile-avatar {
      width:72px; height:72px;
      background:var(--red);
      border-radius:16px;
      display:flex; align-items:center; justify-content:center;
      font-family:'Syne',sans-serif; font-weight:800; font-size:28px;
      box-shadow:0 0 24px var(--red-glow);
    }
    .profile-name { font-family:'Syne',sans-serif; font-size:22px; font-weight:800; margin-bottom:4px; }
    .profile-meta { color:var(--text-muted); font-size:13px; }

    .blood-type-display {
      background:rgba(232,28,28,0.1);
      border:1.5px solid rgba(232,28,28,0.3);
      border-radius:12px;
      padding:16px 24px;
      text-align:center;
      margin-left:auto;
    }
    .blood-type-big { font-family:'Syne',sans-serif; font-size:36px; font-weight:800; color:var(--red); }
    .blood-type-label { font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-top:4px; }

    /* Responsive */
    @media(max-width:900px) {
      .sidebar { transform:translateX(-100%); }
      .main { margin-left:0; }
      .stats-grid { grid-template-columns:1fr 1fr; }
      .topbar { padding:16px 20px; }
      .content { padding:20px; }
    }

    /* Loading */
    .skeleton {
      background: linear-gradient(90deg, var(--surface) 25%, var(--surface2) 50%, var(--surface) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }
    @keyframes shimmer { to { background-position: -200% 0; } }
  </style>
</head>
<body>

  <!-- Toast Container -->
  <div class="toast-container" id="toasts"></div>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">ü©∏</div>
      <div class="logo-text">BloodLink</div>
    </div>

    <nav class="nav-section">
      <div class="nav-label">Overview</div>
      <div class="nav-item active" onclick="showPanel('overview', this)">
        <i class="fas fa-home"></i> Dashboard
      </div>

      <!-- Donor nav -->
      <div id="donor-nav" style="display:none">
        <div class="nav-label" style="margin-top:12px">Donor</div>
        <div class="nav-item" onclick="showPanel('requests-panel', this)">
          <i class="fas fa-tint"></i> Active Requests
          <span class="badge" id="req-count">0</span>
        </div>
        <div class="nav-item" onclick="showPanel('map-panel', this)">
          <i class="fas fa-map-marker-alt"></i> Nearby Map
        </div>
        <div class="nav-item" onclick="showPanel('history-panel', this)">
          <i class="fas fa-history"></i> Donation History
        </div>
      </div>

      <!-- Requester nav -->
      <div id="requester-nav" style="display:none">
        <div class="nav-label" style="margin-top:12px">Request</div>
        <div class="nav-item" onclick="showPanel('new-request', this)">
          <i class="fas fa-plus-circle"></i> New Request
        </div>
        <div class="nav-item" onclick="showPanel('my-requests', this)">
          <i class="fas fa-list"></i> My Requests
        </div>
      </div>

      <div class="nav-label" style="margin-top:12px">Account</div>
      <div class="nav-item" onclick="showPanel('profile', this)">
        <i class="fas fa-user"></i> Profile
      </div>
    </nav>

    <div class="sidebar-footer">
      <div class="user-card" onclick="logout()">
        <div class="avatar" id="sidebar-avatar">?</div>
        <div class="user-info">
          <div class="user-name" id="sidebar-name">Loading...</div>
          <div class="user-role" id="sidebar-role">‚Äî</div>
        </div>
        <i class="fas fa-sign-out-alt" style="color:var(--text-dim);font-size:14px"></i>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <div class="main">
    <div class="topbar">
      <div class="page-title" id="page-title">Dashboard</div>
      <div class="topbar-right">
        <div id="donor-status-indicator" style="display:none"></div>
        <button class="btn btn-ghost" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>

    <div class="content">

      <!-- ===== OVERVIEW PANEL ===== -->
      <div class="panel active" id="panel-overview">
        <div id="alerts-area"></div>

        <div class="stats-grid" id="stats-grid">
          <!-- filled by JS -->
        </div>

        <!-- Donor availability toggle -->
        <div class="toggle-wrap" id="availability-toggle" style="display:none">
          <div>
            <div class="toggle-info">
              <h3>Availability Status</h3>
              <p>Toggle whether you're available to receive blood requests</p>
            </div>
            <div style="margin-top:12px">
              <div class="status-indicator available" id="status-text">
                <div class="status-dot"></div> Available for Donation
              </div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:12px">
            <div class="toggle on" id="avail-toggle" onclick="toggleAvailability()"></div>
            <button class="btn btn-ghost btn-sm" onclick="updateLocation()">
              <i class="fas fa-map-marker-alt"></i> Update Location
            </button>
          </div>
        </div>

        <!-- Quick Request (requester) -->
        <div id="quick-request-card" style="display:none">
          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="fas fa-bolt" style="color:var(--red);margin-right:8px"></i>Quick Blood Request</div>
            </div>
            <div class="card-body">
              <div id="quick-req-msg" class="alert" style="display:none"></div>
              <div class="form-row">
                <div class="form-group">
                  <label>Blood Type Needed</label>
                  <select class="form-control" id="q-blood">
                    <option value="">Select type</option>
                    <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                    <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Urgency Level</label>
                  <select class="form-control" id="q-urgency">
                    <option value="High">üî¥ High ‚Äì Life threatening</option>
                    <option value="Medium">üü° Medium ‚Äì Needs attention</option>
                    <option value="Low">üü¢ Low ‚Äì Scheduled</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>Notes (Optional)</label>
                <input class="form-control" id="q-notes" placeholder="Hospital name, ward number, etc.">
              </div>
              <button class="btn btn-primary" onclick="sendQuickRequest()">
                <i class="fas fa-paper-plane"></i> Send Emergency Request
              </button>
            </div>
          </div>
        </div>

        <!-- Live requests for donor -->
        <div id="live-requests-card" style="display:none">
          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="fas fa-tint" style="color:var(--red);margin-right:8px"></i>Compatible Requests Near You</div>
              <button class="btn btn-ghost btn-sm" onclick="loadDashboard()"><i class="fas fa-sync"></i></button>
            </div>
            <div class="card-body" id="live-requests-body">
              <div class="empty-state">
                <i class="fas fa-search"></i>
                <h3>No Requests Found</h3>
                <p>No urgent requests matching your blood type right now</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== ACTIVE REQUESTS (donor) ===== -->
      <div class="panel" id="panel-requests-panel">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Active Blood Requests</div>
            <button class="btn btn-ghost btn-sm" onclick="loadRequests()"><i class="fas fa-sync"></i> Refresh</button>
          </div>
          <div class="card-body" id="all-requests-body">
            <div class="empty-state">
              <i class="fas fa-tint"></i>
              <h3>Loading...</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== MAP PANEL ===== -->
      <div class="panel" id="panel-map-panel">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Nearby Blood Requests</div>
            <button class="btn btn-primary btn-sm" onclick="updateLocation()">
              <i class="fas fa-crosshairs"></i> Update Location
            </button>
          </div>
          <div class="card-body">
            <div id="map">
              <i class="fas fa-map"></i>
              <span>Allow location access to see nearby requests on the map</span>
              <button class="btn btn-primary" onclick="loadMap()">
                <i class="fas fa-map-marker-alt"></i> Load Map
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== DONATION HISTORY ===== -->
      <div class="panel" id="panel-history-panel">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Donation History</div>
          </div>
          <div class="card-body">
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Blood Type</th>
                  <th>Hospital</th>
                  <th>Status</th>
                  <th>Impact</th>
                </tr>
              </thead>
              <tbody id="history-body">
                <tr><td colspan="5" style="text-align:center;color:var(--text-dim);padding:40px">No donation history yet. Be the first responder!</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ===== NEW REQUEST ===== -->
      <div class="panel" id="panel-new-request">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-plus-circle" style="color:var(--red);margin-right:8px"></i>Submit New Blood Request</div>
          </div>
          <div class="card-body">
            <div id="new-req-msg" class="alert" style="display:none;margin-bottom:16px"></div>
            <div class="form-row">
              <div class="form-group">
                <label>Blood Type Required</label>
                <select class="form-control" id="nr-blood">
                  <option value="">Select blood type</option>
                  <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                  <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
                </select>
              </div>
              <div class="form-group">
                <label>Urgency Level</label>
                <select class="form-control" id="nr-urgency">
                  <option value="High">üî¥ High ‚Äì Critical / Life threatening</option>
                  <option value="Medium">üü° Medium ‚Äì Needs attention soon</option>
                  <option value="Low">üü¢ Low ‚Äì Scheduled operation</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Hospital / Location</label>
                <input class="form-control" id="nr-hospital" placeholder="e.g. City Hospital, Ward 4">
              </div>
              <div class="form-group">
                <label>Units Required</label>
                <input class="form-control" type="number" id="nr-units" placeholder="1" min="1" max="10" value="1">
              </div>
            </div>
            <div class="form-group">
              <label>Additional Notes</label>
              <textarea class="form-control" id="nr-notes" rows="3" placeholder="Patient details, contact number, special requirements..."></textarea>
            </div>
            <div class="form-group">
              <label>Location</label>
              <div style="display:flex;gap:10px">
                <input class="form-control" id="nr-location" placeholder="Your GPS location" readonly style="flex:1">
                <button class="btn btn-ghost" onclick="getLocationForRequest()">
                  <i class="fas fa-map-marker-alt"></i> Get Location
                </button>
              </div>
            </div>
            <button class="btn btn-primary" onclick="sendNewRequest()">
              <i class="fas fa-paper-plane"></i> Submit Request
            </button>
          </div>
        </div>
      </div>

      <!-- ===== MY REQUESTS ===== -->
      <div class="panel" id="panel-my-requests">
        <div class="card">
          <div class="card-header">
            <div class="card-title">My Blood Requests</div>
            <button class="btn btn-primary btn-sm" onclick="showPanel('new-request', null)">
              <i class="fas fa-plus"></i> New Request
            </button>
          </div>
          <div class="card-body" id="my-requests-body">
            <div class="empty-state">
              <i class="fas fa-inbox"></i>
              <h3>No Requests Yet</h3>
              <p>You haven't submitted any blood requests</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== PROFILE ===== -->
      <div class="panel" id="panel-profile">
        <div class="profile-header">
          <div class="profile-avatar" id="profile-avatar">?</div>
          <div>
            <div class="profile-name" id="profile-name">Loading...</div>
            <div class="profile-meta" id="profile-meta">‚Äî</div>
            <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
              <div class="status-indicator available"><div class="status-dot"></div> Verified Member</div>
            </div>
          </div>
          <div class="blood-type-display" id="blood-type-display" style="display:none">
            <div class="blood-type-big" id="profile-blood">‚Äî</div>
            <div class="blood-type-label">Blood Type</div>
          </div>
        </div>
        <div class="form-row">
          <div class="card">
            <div class="card-header"><div class="card-title">Compatibility Info</div></div>
            <div class="card-body" id="compat-info">‚Äî</div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">Quick Stats</div></div>
            <div class="card-body" id="profile-stats">‚Äî</div>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ===== GLOBALS =====
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    let userId = null, userInfo = null;
    let lat = 0, lng = 0;
    let available = true;
    const socket = io();

    const compatibility = {
      'A+': ['A+','A-','O+','O-'], 'A-': ['A-','O-'],
      'B+': ['B+','B-','O+','O-'], 'B-': ['B-','O-'],
      'AB+': ['A+','A-','B+','B-','AB+','AB-','O+','O-'], 'AB-': ['AB-','A-','B-','O-'],
      'O+': ['O+','O-'], 'O-': ['O-']
    };

    // Redirect if not logged in
    if (!token) { window.location.href = '/'; }
    else {
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        userId = payload.id;
      } catch(e) { window.location.href = '/'; }
    }

    // ===== INIT =====
    async function init() {
      // Setup navigation
      if (role === 'donor') {
        document.getElementById('donor-nav').style.display = 'block';
        document.getElementById('availability-toggle').style.display = 'flex';
        document.getElementById('live-requests-card').style.display = 'block';
      } else {
        document.getElementById('requester-nav').style.display = 'block';
        document.getElementById('quick-request-card').style.display = 'block';
      }

      socket.emit('join', userId);

      // Donor notifications
      socket.on('notification', data => {
        showToast('ü©∏ Urgent Request!', data.message || 'New compatible blood request nearby', 'urgent');
        loadDashboard();
      });

      await loadUserInfo();
      await loadDashboard();
    }

    async function loadUserInfo() {
      try {
        const res = await fetch('/api/me', { headers: { Authorization: `Bearer ${token}` } });
        const data = await res.json();
        if (data.success) {
          userInfo = data;
          const uname = data.user.username;
          document.getElementById('sidebar-avatar').textContent = uname[0].toUpperCase();
          document.getElementById('sidebar-name').textContent = uname;
          document.getElementById('sidebar-role').textContent = role === 'donor' ? 'ü©∏ Blood Donor' : 'üè• Requester';
          document.getElementById('profile-avatar').textContent = uname[0].toUpperCase();
          document.getElementById('profile-name').textContent = uname;
          document.getElementById('profile-meta').textContent = `${role.charAt(0).toUpperCase()+role.slice(1)} ¬∑ Member since ${new Date().getFullYear()}`;

          if (data.donor) {
            const bt = data.donor.bloodType;
            document.getElementById('profile-blood').textContent = bt;
            document.getElementById('blood-type-display').style.display = 'block';
            available = data.donor.available;
            updateToggleUI();

            // Compatibility info
            const canDonateTo = Object.entries(compatibility).filter(([k,v]) => v.includes(bt)).map(([k]) => k);
            const canReceiveFrom = compatibility[bt] || [];
            document.getElementById('compat-info').innerHTML = `
              <p style="font-size:13px;color:var(--text-muted);margin-bottom:10px">Blood type <strong style="color:var(--red)">${bt}</strong></p>
              <p style="font-size:12px;margin-bottom:6px;color:var(--text-muted)">Can donate to:</p>
              <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px">
                ${canDonateTo.map(t=>`<span style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);color:#4ade80;padding:3px 10px;border-radius:100px;font-size:12px;font-weight:600">${t}</span>`).join('')}
              </div>
              <p style="font-size:12px;margin-bottom:6px;color:var(--text-muted)">Can receive from:</p>
              <div style="display:flex;gap:6px;flex-wrap:wrap">
                ${canReceiveFrom.map(t=>`<span style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);color:#93c5fd;padding:3px 10px;border-radius:100px;font-size:12px;font-weight:600">${t}</span>`).join('')}
              </div>
            `;
          }

          document.getElementById('profile-stats').innerHTML = `
            <div style="display:flex;flex-direction:column;gap:12px">
              <div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted);font-size:13px">Total ${role==='donor'?'Donations':'Requests'}</span><span style="font-weight:600">0</span></div>
              <div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted);font-size:13px">Status</span><span class="status-indicator available" style="font-size:11px"><div class="status-dot"></div> Active</span></div>
              <div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted);font-size:13px">Next Eligible</span><span style="font-weight:600;font-size:13px">90 days after donation</span></div>
            </div>
          `;
        }
      } catch(e) { console.error(e); }
    }

    async function loadDashboard() {
      try {
        const res = await fetch('/api/dashboard', { headers: { Authorization: `Bearer ${token}` } });
        const data = await res.json();

        if (role === 'donor') {
          const count = (data.requests || []).length;
          document.getElementById('req-count').textContent = count;
          updateStats([
            { icon:'ü©∏', label:'Compatible Requests', value: count, color:'red' },
            { icon:'‚úÖ', label:'Available Status', value: available ? 'Active' : 'Off', color:'green' },
            { icon:'üìç', label:'Location', value: lat ? 'Set' : 'Not set', color:'blue' },
            { icon:'‚ù§Ô∏è', label:'Lives Saved', value: '0', color:'orange' }
          ]);
          renderRequests(data.requests || [], 'live-requests-body');
          renderRequests(data.requests || [], 'all-requests-body');
        } else {
          const myreqs = data.requests || [];
          updateStats([
            { icon:'üìã', label:'Total Requests', value: myreqs.length, color:'red' },
            { icon:'üîÑ', label:'Open Requests', value: myreqs.filter(r=>r.status==='open').length, color:'blue' },
            { icon:'‚úÖ', label:'Fulfilled', value: myreqs.filter(r=>r.status==='fulfilled').length, color:'green' },
            { icon:'‚ö°', label:'Urgent', value: myreqs.filter(r=>r.urgency==='High').length, color:'orange' }
          ]);
          renderMyRequests(myreqs);
        }
      } catch(e) { console.error(e); }
    }

    function updateStats(items) {
      const colors = { red:'red', green:'green', blue:'blue', orange:'orange' };
      document.getElementById('stats-grid').innerHTML = items.map(s => `
        <div class="stat-card">
          <div class="stat-card-top">
            <div class="stat-icon ${s.color}">${s.icon}</div>
            <div class="stat-trend"><i class="fas fa-arrow-up"></i></div>
          </div>
          <div class="stat-num">${s.value}</div>
          <div class="stat-label">${s.label}</div>
        </div>
      `).join('');
    }

    function renderRequests(requests, containerId) {
      const el = document.getElementById(containerId);
      if (!requests.length) {
        el.innerHTML = `<div class="empty-state"><i class="fas fa-check-circle" style="color:var(--success)"></i><h3>All Clear</h3><p>No compatible requests right now. Check back soon.</p></div>`;
        return;
      }
      el.innerHTML = requests.map(r => `
        <div class="request-item">
          <div class="blood-badge">${r.bloodType}</div>
          <div class="request-info">
            <div class="request-title">Blood Needed ‚Äì ${r.bloodType}</div>
            <div class="request-meta">
              <span class="meta-tag"><i class="fas fa-clock"></i> ${timeAgo(r.createdAt)}</span>
              <span class="meta-tag"><i class="fas fa-map-marker-alt"></i> ${r.location?.lat ? `${r.location.lat.toFixed(2)}, ${r.location.lng.toFixed(2)}` : 'Location pending'}</span>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
            <span class="urgency-badge ${(r.urgency||'').toLowerCase()}">${r.urgency || 'Unknown'}</span>
            <button class="btn btn-success btn-sm" onclick="respondToRequest('${r._id}')">Respond</button>
          </div>
        </div>
      `).join('');
    }

    function renderMyRequests(requests) {
      const el = document.getElementById('my-requests-body');
      if (!requests.length) {
        el.innerHTML = `<div class="empty-state"><i class="fas fa-inbox"></i><h3>No Requests Yet</h3><p>Submit your first blood request above.</p></div>`;
        return;
      }
      el.innerHTML = requests.map(r => `
        <div class="request-item">
          <div class="blood-badge">${r.bloodType}</div>
          <div class="request-info">
            <div class="request-title">Request for ${r.bloodType}</div>
            <div class="request-meta">
              <span class="meta-tag"><i class="fas fa-clock"></i> ${timeAgo(r.createdAt)}</span>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
            <span class="urgency-badge ${(r.urgency||'low').toLowerCase()}">${r.urgency}</span>
            <span style="font-size:11px;color:${r.status==='open'?'var(--warning)':'var(--success)'}">
              ${r.status==='open' ? 'üîÑ Searching' : '‚úÖ Fulfilled'}
            </span>
          </div>
        </div>
      `).join('');
    }

    // ===== AVAILABILITY =====
    function toggleAvailability() {
      available = !available;
      updateToggleUI();
      saveDonorStatus();
    }

    function updateToggleUI() {
      const toggle = document.getElementById('avail-toggle');
      const statusText = document.getElementById('status-text');
      toggle.className = 'toggle' + (available ? ' on' : '');
      statusText.className = 'status-indicator ' + (available ? 'available' : 'unavailable');
      statusText.innerHTML = `<div class="status-dot"></div> ${available ? 'Available for Donation' : 'Currently Unavailable'}`;
    }

    function saveDonorStatus() {
      fetch('/api/update-donor', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
        body: JSON.stringify({ available, lat, lng })
      }).then(() => showToast('Status Updated', available ? 'You are now available for donations' : 'You are marked as unavailable', 'info'));
    }

    // ===== LOCATION =====
    function updateLocation() {
      navigator.geolocation.getCurrentPosition(pos => {
        lat = pos.coords.latitude;
        lng = pos.coords.longitude;
        showToast('Location Updated', `${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'success');
        saveDonorStatus();
      }, () => showToast('Location Error', 'Please allow location access', 'error'));
    }

    function getLocationForRequest() {
      navigator.geolocation.getCurrentPosition(pos => {
        lat = pos.coords.latitude;
        lng = pos.coords.longitude;
        document.getElementById('nr-location').value = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
      }, () => showToast('Location Error', 'Please allow location access', 'error'));
    }

    // ===== REQUESTS =====
    async function sendQuickRequest() {
      const bloodType = document.getElementById('q-blood').value;
      const urgency = document.getElementById('q-urgency').value;
      if (!bloodType) return showQuickMsg('Please select a blood type', 'error');
      if (!lat) await new Promise(r => navigator.geolocation.getCurrentPosition(p => { lat=p.coords.latitude; lng=p.coords.longitude; r(); }, r));
      
      const res = await fetch('/api/request-blood', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
        body: JSON.stringify({ bloodType, urgency, lat, lng })
      });
      const data = await res.json();
      const el = document.getElementById('quick-req-msg');
      if (res.ok) {
        el.style.display = 'flex';
        el.className = 'alert alert-success';
        el.innerHTML = `<span class="alert-icon">‚úÖ</span> Request sent! Found ${data.matches} compatible donors.`;
        loadDashboard();
      } else {
        el.style.display = 'flex';
        el.className = 'alert alert-urgent';
        el.innerHTML = `<span class="alert-icon">‚ö†Ô∏è</span> ${data.message}`;
      }
    }

    function showQuickMsg(msg, type) {
      const el = document.getElementById('quick-req-msg');
      el.style.display = 'flex';
      el.className = `alert alert-${type === 'error' ? 'urgent' : type}`;
      el.innerHTML = `<span class="alert-icon">${type==='error'?'‚ö†Ô∏è':'‚úÖ'}</span> ${msg}`;
    }

    async function sendNewRequest() {
      const bloodType = document.getElementById('nr-blood').value;
      const urgency = document.getElementById('nr-urgency').value;
      const notes = document.getElementById('nr-notes').value;
      if (!bloodType) {
        const msg = document.getElementById('new-req-msg');
        msg.style.display = 'flex'; msg.className = 'alert alert-urgent';
        msg.innerHTML = '<span>‚ö†Ô∏è</span> Please select a blood type';
        return;
      }
      if (!lat) getLocationForRequest();
      
      const res = await fetch('/api/request-blood', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
        body: JSON.stringify({ bloodType, urgency, lat, lng })
      });
      const data = await res.json();
      const msg = document.getElementById('new-req-msg');
      msg.style.display = 'flex';
      if (res.ok) {
        msg.className = 'alert alert-success';
        msg.innerHTML = `<span>‚úÖ</span> Request sent! ${data.matches} compatible donors notified.`;
        loadDashboard();
      } else {
        msg.className = 'alert alert-urgent';
        msg.innerHTML = `<span>‚ö†Ô∏è</span> ${data.message}`;
      }
    }

    async function respondToRequest(requestId) {
      showToast('Response Sent', 'Notifying the patient. Please head to the specified location.', 'success');
    }

    async function loadRequests() {
      await loadDashboard();
    }

    function loadMap() {
      const mapDiv = document.getElementById('map');
      if (!lat) {
        navigator.geolocation.getCurrentPosition(pos => {
          lat = pos.coords.latitude;
          lng = pos.coords.longitude;
          mapDiv.innerHTML = `
            <iframe 
              width="100%" height="380" style="border-radius:12px;border:none"
              src="https://www.openstreetmap.org/export/embed.html?bbox=${lng-0.05},${lat-0.05},${lng+0.05},${lat+0.05}&layer=mapnik&marker=${lat},${lng}"
            ></iframe>
          `;
        }, () => {
          mapDiv.innerHTML = '<i class="fas fa-map"></i><span>Location access denied. Please enable GPS.</span>';
        });
      } else {
        mapDiv.innerHTML = `
          <iframe 
            width="100%" height="380" style="border-radius:12px;border:none"
            src="https://www.openstreetmap.org/export/embed.html?bbox=${lng-0.05},${lat-0.05},${lng+0.05},${lat+0.05}&layer=mapnik&marker=${lat},${lng}"
          ></iframe>
        `;
      }
    }

    // ===== PANEL NAVIGATION =====
    function showPanel(panelId, clickedEl) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('panel-' + panelId).classList.add('active');
      if (clickedEl) clickedEl.classList.add('active');

      const titles = {
        'overview': 'Dashboard',
        'requests-panel': 'Active Requests',
        'map-panel': 'Nearby Map',
        'history-panel': 'Donation History',
        'new-request': 'New Blood Request',
        'my-requests': 'My Requests',
        'profile': 'My Profile'
      };
      document.getElementById('page-title').textContent = titles[panelId] || 'Dashboard';

      if (panelId === 'my-requests') renderMyRequestsPanel();
    }

    async function renderMyRequestsPanel() {
      try {
        const res = await fetch('/api/dashboard', { headers: { Authorization: `Bearer ${token}` } });
        const data = await res.json();
        renderMyRequests(data.requests || []);
      } catch(e) {}
    }

    // ===== TOAST =====
    function showToast(title, msg, type = 'info') {
      const container = document.getElementById('toasts');
      const toast = document.createElement('div');
      toast.className = 'toast ' + (type === 'urgent' ? 'urgent' : '');
      const icons = { urgent:'ü©∏', success:'‚úÖ', info:'‚ÑπÔ∏è', error:'‚ö†Ô∏è' };
      toast.innerHTML = `
        <div class="toast-icon">${icons[type]||'‚ÑπÔ∏è'}</div>
        <div style="flex:1">
          <div class="toast-title">${title}</div>
          <div class="toast-sub">${msg}</div>
        </div>
        <div class="toast-close" onclick="this.closest('.toast').remove()">‚úï</div>
      `;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    // ===== UTILS =====
    function timeAgo(dateStr) {
      if (!dateStr) return 'Unknown';
      const diff = Date.now() - new Date(dateStr).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'Just now';
      if (mins < 60) return `${mins}m ago`;
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return `${hrs}h ago`;
      return `${Math.floor(hrs/24)}d ago`;
    }

    function logout() {
      localStorage.clear();
      window.location.href = '/';
    }

    // Start
    init();
  </script>
</body>
</html>